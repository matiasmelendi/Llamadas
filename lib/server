require 'sinatra'
require_relative 'compania_telefonica'
require_relative 'linea_telefonica'
require_relative 'cod_area'
require_relative 'cliente'


compania= CompaniaTelefonica.new

compania.agregar_cliente("Memo",LineaTelefonica.new(CodArea.new(120,54),1511111111))
compania.agregar_cliente("EuroMemo",LineaTelefonica.new(CodArea.new(1,101),1522222222))

@clientes=compania.clientes

def crear_cliente(compania,nombre,cod_local,cod_nacional,nro)
  compania.agregar_cliente(nombre,LineaTelefonica.new(CodArea.new(cod_local,cod_nacional) ,nro))
end

def buscar_cliente(compania,nombre)
  compania.clientes.find(lambda{redirect('/error_404')}) { |c| c.nombre.eql?(nombre)}
end

def borrar_cliente(compania,nombre)
  compania.clientes.delete_if(lambda{redirect('/error_404')}) {|cliente| cliente.nombre.eql?(nombre)}
end

get '/' do
  @clientes=compania.clientes
  erb :home
end

get '/buscar_cliente/' do
  @cliente= buscar_cliente(compania,params[:nombre])
  erb :datos_del_cliente
end

get '/se_ha_eliminado_al_cliente' do
    erb :se_ha_eliminado_al_cliente
end

#HACER FUNCIONAR
delete '/borrar_cliente/:nombre' do
  borrar_cliente(compania,params[:nombre])
  erb :borrar_cliente
end

not_found do
  status 404
  erb :error_404
end

get '/error_404' do
  status 404
end

get '/cliente_creado' do
  erb :cliente_creado
end

get '/linea_invalida' do
  erb :linea_invalida
end

post '/crear_cliente' do
  begin
    crear_cliente(compania,params[:nombre],params[:cod_local],params[:cod_nacional],params[:nro])
    erb :crear_cliente
  rescue YaExisteElClienteException, LineaInvalidaException
    erb :no_se_pudo_crear_el_cliente
  end

end

